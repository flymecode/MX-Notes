# OutOfMemoryError的常见情况和处理方式总结

java.lang.OutOfMemoryError这个错误我相信大部分开发人员都有遇到过，产生该错误的原因大都出于以下原因：JVM内存过小、程序不严密，产生了过多的垃圾。

导致OutOfMemoryError异常的常见原因有以下几种：

1. 内存中加载的数据量过于庞大，如一次从数据库取出过多数据；
2. 集合类中有对对象的引用，使用完后未清空，使得JVM不能回收；
3. 代码中存在死循环或循环产生过多重复的对象实体；
4. 使用的第三方软件中的BUG；
5. 启动参数内存值设定的过小；



## 解决java.lang.OutOfMemoryError的方法

### 一、增加jvm的内存大小。

-  在执行某个class文件时候，可以使用 java -Xmx256M aa.class 来设置运行 aa.class 时 jvm 所允许占用的最大内存为256M。
-  对 tomcat 容器，可以在启动时对 jvm 设置内存限度。对 tomcat ，可以在 catalina.bat 中添加：

```
set CATALINA_OPTS=-Xms128M -Xmx256M
set JAVA_OPTS=-Xms128M -Xmx256M
```

### 二、 优化程序，释放垃圾。

主要包括避免死循环，应该及时释放种资源：内存, 数据库的各种连接，防止一次载入太多的数据。导致java.lang.OutOfMemoryError的根本原因是程序不健壮。因此，从根本上解决Java内存溢出的唯一方法就是修改程序，及时地释放没用的对象，释放内存空间。 遇到该错误的时候要仔细检查程序，嘿嘿，遇多一次这种问题之后，以后写程序就会小心多了。

 **PermGen space** 造成的原因是程序中使用大量的 jar 和 class ,是使 java 虚拟机装载的类空间不够，设置参数

```xml
JAVA_OPTS=" -XX:PermSize=64M -XX:MaxPermSize=128m"
```

**Java heap** **space**原因是java虚拟机创建的对象太多，在进行垃圾回收之间，虚拟机分配的到堆内存空间已经用满了，与Heap space有关。解决这个问题有两个方法：

- 检查程序，是否有死循环，和创建大量不必要的对象。
- 增加 Java 虚拟机中堆的大小。

```xml
set JAVA_OPTS= -Xms256m -Xmx1024m
```





## Java代码导致OutOfMemoryError错误的解决

需要重点排查以下几点：

1. 检查代码中是否有死循环或递归调用。
2. 检查是否有大循环重复产生新对象实体。
3. 检查对数据库查询中，是否有一次获得全部数据的查询。一般来说，如果一次取十万条记录到内存，就可能引起内存溢出。这个问题比较隐蔽，在上线前，数据库中数据较少，不容易出问题，上线后，数据库中数据多了，一次查询就有可能引起内存溢出。因此对于数据库查询尽量采用分页的方式查询。
4. 检查List、Map等集合对象是否有使用完后，未清除的问题。List、Map等集合对象会始终存有对对象的引用，使得这些对象不能被GC回收。



